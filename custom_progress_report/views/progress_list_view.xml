<odoo>
    <template id="portal_my_progress_reports" name="Portal My Progress Reports">
        <t t-call="portal.portal_layout">
            <div class="container mt-4">
                <style>
                    .progress-table th { white-space: nowrap; }
                    .progress-table { font-size: 0.95rem; }
                    @media (max-width: 1199.98px) { .progress-table { font-size: 0.875rem; } }
                    @media (max-width: 991.98px)  { .progress-table { font-size: 0.6125rem; } }
                    @media (max-width: 767.98px)  { .progress-table { font-size: 0.75rem; } }
                </style>
                <div class="d-flex justify-content-between w-100 mb-3 flex-wrap">
                    <h3 class="mb-3">Task Progress Reports</h3>
                    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#createReportForm">
                    Create Report
                </button>
                </div>
                <!-- Collapsible Form -->
                <div class="collapse mb-4" id="createReportForm">
                    <form id="progressCreateForm" action="/my/progress_reports/create" method="POST" enctype="multipart/form-data" class="border rounded p-3">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <div id="taskRowsContainer">
                            <div class="task-row row mb-2">
                                <div class="col-md-4">
                                    <label>Task Name</label>
                                    <select name="task_ids[]" class="form-control task-select">
                                        <option value="">Select Task</option>
                                        <t t-foreach="request.env['project.task'].sudo().search([])" t-as="task">
                                            <option t-att-value="task.id">
                                                <t t-esc="task.name"/>
                                            </option>
                                        </t>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label>Date</label>
                                    <input type="date" name="date" class="form-control"/>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label>Done Quantity</label>
                                    <input type="number" step="any" name="done_quantities[]" class="form-control"/>
                                </div>
                                <div class="col-md-2">
                                    <label>Planned Qty</label>
                                    <input type="number" step="any" name="planned_quantities[]" class="form-control planned-qty" readonly='1'/>
                                </div>
                                <div class="col-md-2">
                                    <label>Unit</label>
                                    <input type="text" name="units[]" class="form-control unit" readonly='1'/>
                                </div>
                                <div class="col-md-3">
                                    <label>Description</label>
                                    <textarea name="task_descriptions[]" class="form-control task-desc"></textarea>
                                </div>
                                <div class="col-md-3">
                                    <label>Image</label>
                                    <input type="file" name="task_images[]" accept="image/*" class="form-control"/>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger remove-task-btn">-</button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <button type="button" id="addTaskBtn" class="btn btn-primary">Add Task</button>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary mt-2">Submit Report</button>
                        </div>
                    </form>
                </div>
                <!-- Under your existing form -->
                <div class="accordion mt-5" id="dailyReportsAccordion">
                    <h4 class="mb-3">Submitted Progress Reports</h4>
                    <t t-if="grouped_reports">
                        <t t-foreach="grouped_reports" t-as="grp" t-foreach-index="idx">
                            <div class="accordion-item mb-2 shadow-sm">
                                <h2 class="accordion-header d-flex justify-content-between align-items-center">
                                    <t t-set="batch_id" t-value="grp['records'] and grp['records'][0].report_batch_id or idx"/>
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" t-attf-data-bs-target="#collapse#{batch_id}" t-attf-aria-controls="collapse#{batch_id}" aria-expanded="false">
                                        <span class="d-inline-flex align-items-center gap-2 text-nowrap">
                                            <strong class="text-nowrap">Progress Report</strong>
                                            <small class="text-muted text-nowrap">(Date: <t t-esc="grp['label']"/> )</small>
                                        </span>
                                    </button>
                                </h2>
                                <div t-attf-id="collapse#{batch_id}" class="accordion-collapse collapse" data-bs-parent="#dailyReportsAccordion" t-attf-aria-labelledby="heading#{batch_id}">
                                    <div class="accordion-body">
                                        <div class="table-responsive">
                                        <table class="table table-bordered table-striped mb-0 progress-table">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Task Name</th>
                                                    <th>Description</th>
                                                    <th>Planned Qty</th>
                                                    <th>Done Qty</th>
                                                    <th>Unit</th>
                                                    <th>Progress Rate (%)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <t t-foreach="grp['records']" t-as="report_line">
                                                    <tr>
                                                        <td>
                                                            <span class="d-inline-flex align-items-center gap-2">
                                                                <t t-if="report_line.task_image">
                                                                    <img t-att-src="'data:%s;base64,%s' % (
                                                                        (report_line.task_image_mimetype or 'image/jpeg'),
                                                                        (report_line.task_image.decode('utf-8') if isinstance(report_line.task_image, (bytes, bytearray)) else report_line.task_image)
                                                                    )" style="width:40px;height:40px;object-fit:cover;border-radius:4px;" class="o_portal_contact_img rounded o_object_fit_cover"/>
                                                                </t>
                                                                <span><t t-esc="report_line.task_name.name"/></span>
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <t t-esc="report_line.task_description"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="report_line.planned_quantity"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="report_line.done_quantity"/>
                                                        </td>
                                                        <td>
                                                            <t t-esc="report_line.unit"/>
                                                        </td>
                                                        <td>
                                                            <span t-attf-class="badge #{'bg-success' if report_line.progress_rate >= 90 else ('bg-warning' if report_line.progress_rate >= 50 else 'bg-danger')}">
                                                                <t t-esc="'%.2f' % report_line.progress_rate"/>%
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </t>
                                            </tbody>
                                        </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </t>
                    <t t-else="">
                        <p class="text-muted">No progress reports submitted yet.</p>
                    </t>
                </div>
            </div>
        </t>
        <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function () {
              
                    function fetchTaskDetails(row, taskId) {
        if (!taskId) return;

        fetch(`/get_task_details?task_id=${taskId}`)
            .then(response => response.json())
            .then(data => {
                row.querySelector('.task-desc').value = data.description || '';
                row.querySelector('.planned-qty').value = data.planned_quantity || '';
                row.querySelector('.unit').value = data.unit || '';
            });
    }

    // Handle task selection change
    document.querySelector('#taskRowsContainer').addEventListener('change', function (e) {
        if (e.target.classList.contains('task-select')) {
            const row = e.target.closest('.task-row');
            fetchTaskDetails(row, e.target.value);
        }
    });

    // Add new task row
    document.querySelector('#addTaskBtn').addEventListener('click', function () {
        const container = document.querySelector('#taskRowsContainer');
        const firstRow = container.querySelector('.task-row');
        const newRow = firstRow.cloneNode(true);

        newRow.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
        container.appendChild(newRow);
    });

    // Remove task row
    document.querySelector('#taskRowsContainer').addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-task-btn')) {
            const rows = document.querySelectorAll('.task-row');
            if (rows.length > 1) {
                e.target.closest('.task-row').remove();
            }
        }
    });

    // Reindex file inputs on submit so server can map each row reliably
    const form = document.getElementById('progressCreateForm');
    if (form) {
        form.addEventListener('submit', function () {
            const rows = document.querySelectorAll('#taskRowsContainer .task-row');
            rows.forEach((row, idx) => {
                const fileInput = row.querySelector('input[type="file"][name="task_images[]"]');
                if (fileInput) {
                    fileInput.setAttribute('name', `task_images_${idx}`);
                }
            });
        });
    }
            });
        </script>
    </template>
</odoo>